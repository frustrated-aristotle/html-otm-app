<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Site</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
      integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <style type="text/css">
      a {
        color: #e1e8ed;
      }
      .navbar .form-control {
        width: 50px;
        background-color: antiquewhite;
      }

      .content {
        color: black;
        font-weight: normal;
      }


      .rounded-card {
        border-radius: 35px;
        border: 1px solid #e1e8ed;
      }

      body {
        background-color: #ffff;
      }

      .h7 {
        font-size: 0.8rem;
      }

      .gedf-wrapper {
        margin-top: 0.97rem;
      }

      @media (min-width: 992px) {
        .gedf-main {
          margin: 0 auto; /* Dikey hizalamayı sağlar */
          float: none; /* Kaydırma özelliğini kaldırır */
          padding-left: 4rem;
          padding-right: 4rem;
        }

        .gedf-card {
          margin-bottom: 2.77rem;
        }
      }

      @media (max-width: 991px) {
        .gedf-card {
          margin-bottom: 20px; /* Kartlar arasındaki boşluğu artırdık */
          height: auto; /* Kartların dikey boyutunu otomatik olarak ayarladık */
        }

        .card-body {
          padding: 10px; /* Kart içeriği ile sınırlar arasındaki boşluğu azalttık */
        }

        .content {
          font-size: 18px; /* Kart içeriğinin metin boyutunu küçülttük */
        }
      }

      @media (max-width: 768px) {
        .card-body {
          padding: 10px;
        }

        .content {
          font-size: 16px;
        }

        .vertical-line {
          display: none;
        }
      }

      .gedf-card:hover {
        background-color: rgb(243, 243, 243);
      }
      /**Reset Bootstrap*/
      .dropdown-toggle::after {
        content: none;
        display: none;
      }

      .text-center {
        text-align: center;
      }

      .vertical-line {
        border-left: 1px solid #ccc;
        height: 100%;
      }

      .spotify-link {
        position: relative;
      }

      .card-content {
        font-size: 23px;
        cursor: pointer;
      }

      .height {
        align-content: center;
        min-height: 75px;
      }

      .card-link {
        color: black;
      }
      .share {
        color: black;
        transition: margin-right 2s;
      }
      .share:hover {
        color: green;
      }

      .sticky {
        position: sticky;
        bottom: 0;
        right: 0;
        z-index: 0;
      }
      .profile-img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        margin-right: 10px;
        border-color: #7952b3;
        border-style: outset;
      }

      .profile-img:hover{
        filter: brightness(90%);
        cursor: pointer;
      }
      .profile-a{
        color: black;
      }
      .footer{
        color: black;
        margin-left: 15px;
        font-style: normal;
        padding: 5px 10px 5px 10px;
      }

      .footer:hover{
        background-color: whitesmoke;
        filter: brightness(90%);
        border-radius: 15px;
      }
    </style>
  </head>
  <body>
    <!-- <nav class="navbar sticky-top navbar-light bg-light container-xxl flex-wrap flex-md-nowrap">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">Sticky top</a>
          <a class="navbar-brand" href="#">Sticky top</a>
          <a class="navbar-brand" href="#">Sticky top</a>
          <a class="navbar-brand" href="#">Sticky top</a>
          <a class="navbar-brand" href="#">Sticky top</a>
        </div>
      </nav> -->

    <nav class="navbar navbar-expand-lg" style="background-color: #7952b3">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Navbar</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarTogglerDemo02"
          aria-controls="navbarTogglerDemo02"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarTogglerDemo02">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="#">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Link</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <br />
    <br />
    <div class="container gedf-wrapper">
      <div class="justify-content-center">
        <div class="col-md-8 gedf-main">
          <div
            class="card-body card gedf-card overflow-hidden shadow-lg rounded-pill rounded-lg rounded-card"
          >
            <form id="sectionCreationForm">
              <div class="form-group">
                <label for="postContent">Kesit</label>
                <textarea
                  class="form-control"
                  id="postContent"
                  rows="3"
                  placeholder="Neye güldün?"
                ></textarea>
              </div>
              <div class="form-group">
                <label for="postLink">Link</label>
                <input
                  type="text"
                  class="form-control"
                  id="postLink"
                  placeholder="Link"
                  required
                />
              </div>
              <button
                type="submit"
                id="createSection"
                class="btn"
                style="background-color: #7952b3; color: whitesmoke"
              >
                Kesit Oluştur
              </button>
            </form>
          </div>
        </div>

        <div id="cardContainer" class="col-md-8 gedf-main"></div>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.1/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript"></script>
    <script src="https://open.spotify.com/embed/iframe-api/v1" async></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
    <script>
      //Card Related Jobs
      var userID = localStorage.getItem("uid");
      console.log(userID);
      
      const firebaseConfig = {
        apiKey: "AIzaSyBhJTyPZintjfuPLN-yI6ykNeE48OVrrt4",
        authDomain: "otm-share.firebaseapp.com",
        projectId: "otm-share",
        storageBucket: "otm-share.appspot.com",
        messagingSenderId: "348092862020",
        appId: "1:348092862020:web:ae23c9664f7998b011b611",
        measurementId: "G-MXBLQQQSS3",
      };
    
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
    
      db.collection("Section").orderBy("createTime", "desc").get().then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          const creatorUid = doc.data().creator;
          let userName = "";
          let userPP="";
          // console.log("Create Time: "+doc.data().createTime);
          const pastTime= doc.data().createTime.toDate();
          const elapsedTime = timeSince(pastTime);
          // Belirli bir kullanıcının verilerini Users koleksiyonundan al
          db.collection("Users").doc(creatorUid).get().then((userDoc) => {
            if (userDoc.exists) {

              // Kullanıcının adını alma
              userName = userDoc.data().username;
              userPP = userDoc.data().avatar;
              console.log(userPP);
              const card = document.createElement("div");
              card.classList.add(
                "card",
                "gedf-card",
                "overflow-hidden",
                "shadow-lg",
                "rounded-pill",
                "rounded-lg",
                "rounded-card"
              );
    
              card.addEventListener("click", function () {
                console.log("URL: " + doc.data().url);
                // window.location.href = doc.data().url;
                window.open(doc.data().url, "_blank");
              });
    
              const title = document.createElement("div");
              title.classList.add("ml-3", "mr-3", "mt-3", "h5");
    
              //Username Link
              const profileImg = document.createElement("img");
              profileImg.classList.add("profile-img");
              profileImg.src = userPP;
    
              var seasonAndEpisodeStr = doc.data().seasonAndEpisode + "";
              var arr = seasonAndEpisodeStr.split(".");
              seasonAndEpisodeStr =
                "Sezon " + arr[0] + " Bölüm " + arr[1] + " - " + arr[2];
    
              const hr = document.createElement("hr");
              hr.classList.add("hr", "hr-blurry");
    
              const body = document.createElement("div");
              body.classList.add("card-body", "mr-1", "row", "height");
    
              const contentCol = document.createElement("div");
              contentCol.classList.add("col-md-9", "h4");
    
              const content = document.createElement("div");
              content.setAttribute("style", "cursor: pointer");
              content.classList.add("content");
              content.textContent = doc.data().content;
              contentCol.appendChild(content);
              body.appendChild(contentCol);
    
              const hr2 = document.createElement("hr");
              hr2.classList.add("hr", "hr-blurry");
    
              const footerDiv = document.createElement("div");
              footerDiv.classList.add("mb-3");
    
              const shareIcon = document.createElement("i");
              const spoti = document.createElement("icon");
              spoti.classList.add("bi-spotify");
    
              shareIcon.addEventListener("click", function () {
                console.log("Share div working hey dudii");
                event.stopPropagation();
                copyUrlToClipboard(doc.data().url);
              });
    
              shareIcon.classList.add("bi", "bi-share", "footer");//,"card-footer");

              const loveIcon = document.createElement("i");
              loveIcon.classList.add("bi", "bi-heart", "footer");
              loveIcon.textContent=" 999";

              const commentIcon = document.createElement("i");
              commentIcon.classList.add("bi", "bi-chat", "footer");
        
              // shareIcon.textContent = " Paylaş";
              footerDiv.appendChild(shareIcon);
              footerDiv.appendChild(commentIcon);
              footerDiv.appendChild(loveIcon);
              // shareIcon.appendChild(spoti);
              card.appendChild(title);
              title.appendChild(profileImg);
              // title.innerHTML += userName;
              // title.innerHTML += '<a class="profile-a" href="/profile/'+userName+'">'+userName+'</a>';
              title.innerHTML += '<a class="profile-a" href="profile.html?='+userName+'">'+userName+'</a>';
              title.innerHTML += "     "+ '<span style="color: gray">• '+ elapsedTime+'</span>';
              title.addEventListener("click", function()
              {
                event.stopPropagation();
                window.location="profile.html?="+userName;
              });
              card.appendChild(hr);
              card.appendChild(body);
              card.appendChild(hr2);
              card.appendChild(footerDiv);
    
              // Kartı belirli bir container'a ekleyin
              const container = document.getElementById("cardContainer");
              container.appendChild(card);
            } else {
              console.log("Kullanıcı belgesi bulunamadı.");
            }
          }).catch((error) => {
            console.error("Kullanıcı belgesini alma hatası: ", error);
          });
        });
      });
    
      function timeSince(pastTime)
      {
        const now = Date.now();
        const elapsed = now - pastTime; // milisaniye cinsinden geçen süre

        const seconds = Math.floor(elapsed / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        const months = Math.floor(days / 30);

        if (days >= 1) {
          const pastDate = new Date(pastTime);
        return pastDate.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' });
      } else if (seconds < 60) {
        return `${seconds} saniye`;
      } else if (minutes < 60) {
        return `${minutes} dakika`;
      } else if (hours < 24) {
        return `${hours} saat`;
      }
    }
      function copyUrlToClipboard(url) {
        // Geçici bir textarea oluştur
        var textarea = document.createElement("textarea");
        // URL'yi textarea içine yerleştir
        textarea.value = url;
        // Doküman içinde textarea'yı gizle
        textarea.style.position = "fixed";
        textarea.style.opacity = 0;
        document.body.appendChild(textarea);
        // URL'yi seç ve kopyala
        textarea.select();
        document.execCommand("copy");
        // Artık textarea'ya ihtiyacımız yok, dolayısıyla onu kaldır
        document.body.removeChild(textarea);
        alert("Link Kopyalandı Şefim!");
      }
    
      //Sharing a new section:
      var highestId = 0;
      function findHighestID() {
        return db
          .collection("Section")
          .orderBy("id", "desc")
          .limit(1)
          .get()
          .then((querySnapshot) => {
            querySnapshot.forEach((doc) => {
              console.log(doc.id, " => ", doc.data());
              highestId = doc.data().id + 1;
              console.log(highestId);
            });
          });
      }
    
      const sectionForm = document.getElementById("sectionCreationForm");
      sectionForm.addEventListener("submit", function (event) {
        event.preventDefault(); // Formun varsayılan davranışını engelle
    
        // Burada kayıt işlemlerini yapabilirsiniz
        sectionCreation();
        sectionForm.reset();
      });
    
      function sectionCreation() {
        var postLink = document.getElementById("postLink").value;
        var content = document.getElementById("postContent").value;
        if (localStorage.getItem("uid")) {
          db.collection("Section")
            .orderBy("id", "desc")
            .limit(1)
            .get()
            .then((querySnapshot) => {
              querySnapshot.forEach((doc) => {
                console.log(doc.id, " => ", doc.data());
                highestId = doc.data().id + 1;
                createSection(postLink, content);
              });
            });
        } else alert("uid is", localStorage.getItem("uid"));
      }
    
      function createSection(postLink, content) {
        const currentTimeStamp = firebase.firestore.Timestamp.fromDate(new Date());

        db.collection("Section")
          .add({
            content: content,
            createTime: currentTimeStamp,
            creator: localStorage.getItem("uid"),
            id: highestId,
            isActive: true,
            likeCount: 0,
            likers: [],
            saveCount: 0,
            savers: [],
            sharers: [],
            shareCount: 0,
            url: postLink,
          })
          .then(function (docRef) {
            console.log("Document written with ID: ", docRef.id);
            addSectionToCreator(docRef.id);
            // Veri başarıyla eklendiğinde kullanıcıya bilgi vermek için uygun bir mesaj görüntüleyebilirsiniz.
            alert("Veri başarıyla eklendi!");
          })
          .catch(function (error) {
            console.error("Error adding document: ", error);
            // Hata durumunda kullanıcıya bilgi vermek için uygun bir mesaj görüntüleyebilirsiniz.
            alert("Veri eklenirken bir hata oluştu!");
          });
      }
      
      function addSectionToCreator(docId)
      {
        const uid = localStorage.getItem("uid"); // Kullanıcı kimliğini al
        console.log(uid);
        // Kullanıcı belgesini al ve güncelleme işlemini gerçekleştir
        db.collection("Users").doc(uid).get().then((doc) => {
          if (doc.exists) {
            const shares = doc.data().shares || []; // Kullanıcının mevcut paylaşımlarını al, yoksa boş bir dizi oluştur

            // Yeni bir paylaşım ekleyerek paylaşımlar dizisini güncelle
            shares.push(docId);

            // Kullanıcı belgesini güncelle
            db.collection("Users").doc(uid).update({
              shares: shares
            })
            .then(() => {
              console.log("Shares eklendi");
            })
            .catch((error) => {
              console.error("Shares eklenemedi ", error);
            });
          } else {
            console.log("Sharesde kullanıcı belgesi bulunamadı.");
          }
        })
        .catch((error) => {
          console.error("Kullanıcı belgesini alma hatası: ", error);
        });

      }
       /*
      var collectionRef = db.collection("Section");
      // Toplu işlem başlat
      const batch = db.batch();

      // Koleksiyondaki her belgeyi güncelle
      collectionRef
        .get()
        .then((querySnapshot) => {
          querySnapshot.forEach((doc) => {
            // Her belgeyi güncelleme işlemine ekle
            batch.update(doc.ref, {
                //creator: "AXDi0H549id10hfdf6sxxmiAW0h1" 
                likers: [],
                savers: [],
                sharers: [],
            });
          });

          // Toplu işlemi commit et
          return batch.commit();
        })
        .then(() => {
          console.log("Tüm belgeler başarıyla güncellendi!");
        })
        .catch((error) => {
          console.error("Belgeler güncellenirken hata oluştu: ", error);
        });
        */
    </script>
 
    <!-- <script>
      //Card Related Jobs
      var userID = localStorage.getItem("uid");
      console.log(userID);
      const firebaseConfig = {
        apiKey: "AIzaSyBhJTyPZintjfuPLN-yI6ykNeE48OVrrt4",
        authDomain: "otm-share.firebaseapp.com",
        projectId: "otm-share",
        storageBucket: "otm-share.appspot.com",
        messagingSenderId: "348092862020",
        appId: "1:348092862020:web:ae23c9664f7998b011b611",
        measurementId: "G-MXBLQQQSS3",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      db.collection("Section")
        .get()
        .then((querySnapshot) => {
          querySnapshot.forEach((doc) => {

            const creatorUid = doc.data().creator;
            let userName="";
            // Belirli bir kullanıcının verilerini Users koleksiyonundan al
            db.collection("Users").doc(creatorUid).get().then((userDoc) => {
              if (userDoc.exists) {
                // Kullanıcının adını alma
                userName = userDoc.data().username;

                const card = document.createElement("div");
            card.classList.add(
              "card",
              "gedf-card",
              "overflow-hidden",
              "shadow-lg",
              "rounded-pill",
              "rounded-lg",
              "rounded-card"
            );
            card.addEventListener("click", function () {
              console.log("URL: " + doc.data().url);
              // window.location.href = doc.data().url;
              window.open(doc.data().url, "_blank");
            });
            const title = document.createElement("div");
            title.classList.add("ml-3", "mr-3", "mt-3", "h5");
            const profileImg = document.createElement("img");
            profileImg.classList.add("profile-img");
            profileImg.src ="img.png";
            var seasonAndEpisodeStr = doc.data().seasonAndEpisode + "";
            var arr = seasonAndEpisodeStr.split(".");
            seasonAndEpisodeStr =
              "Sezon " + arr[0] + " Bölüm " + arr[1] + " - " + arr[2];

            const hr = document.createElement("hr");
            hr.classList.add("hr", "hr-blurry");

            const body = document.createElement("div");
            body.classList.add("card-body", "mr-1", "row", "height");

            const contentCol = document.createElement("div");
            contentCol.classList.add("col-md-9", "h4");
            const content = document.createElement("div");
            content.classList.add("content");
            content.textContent = doc.data().content;
            contentCol.appendChild(content);
            body.appendChild(contentCol);
            //body.appendChild(linkCol);

            const hr2 = document.createElement("hr");
            hr2.classList.add("hr", "hr-blurry");

            const shareDiv = document.createElement("div");
            shareDiv.classList.add("mb-3");
            const shareIcon = document.createElement("i");
            const spoti = document.createElement("icon");
            spoti.classList.add("bi-spotify");
            shareIcon.addEventListener("click", function () {
              console.log("Share div working hey dudii");
              event.stopPropagation();
              copyUrlToClipboard(doc.data().url);
            });
            shareIcon.classList.add("bi", "bi-share", "footer", "share");
            shareIcon.textContent = " Paylaş";
            shareDiv.appendChild(shareIcon);
            shareIcon.appendChild(spoti);

            card.appendChild(title);
            title.appendChild(profileImg);
            title.innerHTML+= userName;//seasonAndEpisodeStr;
            card.appendChild(hr);
            card.appendChild(body);
            card.appendChild(hr2);
            card.appendChild(shareDiv);
            // Kartı belirli bir container'a ekleyin
            const container = document.getElementById("cardContainer"); // Örnek bir container
            container.appendChild(card);
              } else {
                console.log("Kullanıcı belgesi bulunamadı.");
              }
            }).catch((error) => {
              console.error("Kullanıcı belgesini alma hatası: ", error);
            });
          });
        });
      function copyUrlToClipboard(url) {
        // Geçici bir textarea oluştur
        var textarea = document.createElement("textarea");
        // URL'yi textarea içine yerleştir
        textarea.value = url;
        // Doküman içinde textarea'yı gizle
        textarea.style.position = "fixed";
        textarea.style.opacity = 0;
        document.body.appendChild(textarea);
        // URL'yi seç ve kopyala
        textarea.select();
        document.execCommand("copy");
        // Artık textarea'ya ihtiyacımız yok, dolayısıyla onu kaldır
        document.body.removeChild(textarea);
        alert("Link Kopyalandı Şefim!");
      }
      /*
      var collectionRef = db.collection("Section");
      // Toplu işlem başlat
      const batch = db.batch();

      // Koleksiyondaki her belgeyi güncelle
      collectionRef
        .get()
        .then((querySnapshot) => {
          querySnapshot.forEach((doc) => {
            // Her belgeyi güncelleme işlemine ekle
            batch.update(doc.ref, {
                //creator: "AXDi0H549id10hfdf6sxxmiAW0h1" 
                likers: [],
                savers: [],
                sharers: [],
            });
          });

          // Toplu işlemi commit et
          return batch.commit();
        })
        .then(() => {
          console.log("Tüm belgeler başarıyla güncellendi!");
        })
        .catch((error) => {
          console.error("Belgeler güncellenirken hata oluştu: ", error);
        });
        */

      //Sharing a new section:
      var highestId = 0;
      function findHighestID() {
        return db
          .collection("Section")
          .orderBy("id", "desc")
          .limit(1)
          .get()
          .then((querySnapshot) => {
            querySnapshot.forEach((doc) => {
              console.log(doc.id, " => ", doc.data());
              highestId = doc.data().id + 1;
              console.log(highestId);
            });
          });
      }
      const sectionForm = document.getElementById("sectionCreationForm");
      sectionForm.addEventListener("submit", function (event) {
        event.preventDefault(); // Formun varsayılan davranışını engelle

        // Burada kayıt işlemlerini yapabilirsiniz
        sectionCreation();
        sectionForm.reset();
      });
      function sectionCreation() {
        var postLink = document.getElementById("postLink").value;
        var content = document.getElementById("postContent").value;
        if (localStorage.getItem("uid")) {
          db.collection("Section")
            .orderBy("id", "desc")
            .limit(1)
            .get()
            .then((querySnapshot) => {
              querySnapshot.forEach((doc) => {
                console.log(doc.id, " => ", doc.data());
                highestId = doc.data().id + 1;
                createSection(postLink, content);
              });
            });
        } else alert("uid is", localStorage.getItem("uid"));
      }

      function createSection(postLink, content) {
        db.collection("Section")
          .add({
            content: content,
            creator: localStorage.getItem("uid"),
            id: highestId,
            isActive: true,
            likeCount: 0,
            likers: [],
            saveCount: 0,
            savers: [],
            sharers: [],
            shareCount: 0,
            url: postLink,
          })
          .then(function (docRef) {
            console.log("Document written with ID: ", docRef.id);
            // Veri başarıyla eklendiğinde kullanıcıya bilgi vermek için uygun bir mesaj görüntüleyebilirsiniz.
            alert("Veri başarıyla eklendi!");
          })
          .catch(function (error) {
            console.error("Error adding document: ", error);
            // Hata durumunda kullanıcıya bilgi vermek için uygun bir mesaj görüntüleyebilirsiniz.
            alert("Veri eklenirken bir hata oluştu!");
          });
      }
    </script>
  </body> -->
</html>
